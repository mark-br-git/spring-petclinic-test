pipeline {
    agent any

      stages {
        stage('Creating tag') {
            steps {
                script {
                withCredentials([usernamePassword(credentialsId: 'git', passwordVariable: 'GIT_PASSWORD', usernameVariable: 'GIT_USERNAME')]) {
                def currentTag = sh(returnStdout: true, script: 'git describe --abbrev=0 --tags').trim()
            //    def newVersion = sh(returnStdout: true, script: "python3 semver_script.py $currentTag")
                 def newVersion = "1.19.0"
              
            //    sh("git tag -a some_tag11 -m 'Jenkins'")
                sh "git tag $newVersion"
                sh('git push https://${GIT_USERNAME}:${GIT_PASSWORD}@github.com/mark-br-git/spring-petclinic-test.git $newVersion')
                }
                }
             }
           }

  //      stage('Bump Version and Create Tag') {
 //           steps {
  //              script {
  //                  def currentTag = sh(returnStdout: true, script: 'git describe --abbrev=0 --tags').trim()
  //                  def newVersion = sh(returnStdout: true, script: "python3 semver_script.py $currentTag")

   //                 sh "git tag $newVersion"
  //                  sh "git push origin $newVersion"
  //              }
   //         }
   //     }

            stage('Build Docker Image') {
               steps {
                  script {
                    // Define Docker Hub repository and image name
                    def dockerRepo = 'mark67br/main'
                    def imageName = "${dockerRepo}:$newVersion"

                    // Build the Docker image with the git tag
                    sh "docker build -t ${imageName} -f Dockerfile_main ."

                    // Log in to Docker Hub
                    withCredentials([usernamePassword(credentialsId: 'docker-hub-credentials', usernameVariable: 'DOCKERHUB_USERNAME', passwordVariable: 'DOCKERHUB_PASSWORD')]) {
                    sh "docker login -u ${DOCKERHUB_USERNAME} -p ${DOCKERHUB_PASSWORD}"
                    }

                    // Push the Docker image to Docker Hub repository
                    sh "docker push ${imageName}"
                }
            }

         }
}
